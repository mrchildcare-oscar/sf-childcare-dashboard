<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SF Child Care Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
        
        /* Header */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-content { max-width: 1600px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .header p { font-size: 13px; opacity: 0.9; }
        .header-stats { display: flex; gap: 12px; flex-wrap: wrap; }
        .stat-pill { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; text-align: center; min-width: 100px; }
        .stat-value { font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 11px; opacity: 0.9; text-transform: uppercase; }
        .help-icon { background: rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; }
        
        /* Layout */
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 280px 1fr 320px; gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        /* Sidebar */
        .sidebar { position: sticky; top: 20px; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; }
        .sidebar h2 { font-size: 16px; margin-bottom: 12px; }
        .search-box { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .search-box:focus { outline: none; border-color: #667eea; }

        /* Active Filters */
        .active-filters { padding: 12px 20px; border-bottom: 1px solid #e0e0e0; max-height: 200px; overflow-y: auto; }
        .active-filters-header { font-size: 11px; font-weight: 600; text-transform: uppercase; color: #999; margin-bottom: 8px; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 6px; }
        .filter-chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 16px; font-size: 12px; }
        .filter-chip-close { cursor: pointer; font-weight: bold; font-size: 14px; line-height: 1; opacity: 0.8; }
        .filter-chip-close:hover { opacity: 1; }
        .clear-all-btn { padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 16px; font-size: 11px; cursor: pointer; font-weight: 600; }
        .clear-all-btn:hover { background: #d32f2f; }
        
        /* Filters */
        .filter-section { border-bottom: 1px solid #f0f0f0; }
        .filter-header { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; }
        .filter-header:hover { background: #f9f9f9; }
        .filter-title { font-size: 13px; font-weight: 600; text-transform: uppercase; color: #555; }
        .filter-arrow { font-size: 12px; transition: transform 0.3s; color: #999; }
        .filter-arrow.open { transform: rotate(180deg); }
        .filter-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .filter-content.open { max-height: 400px; overflow-y: auto; }
        .filter-body { padding: 0 20px 16px; }
        .filter-option { display: flex; align-items: center; padding: 8px 0; cursor: pointer; }
        .filter-option input { margin-right: 10px; cursor: pointer; }
        .filter-option label { font-size: 13px; cursor: pointer; flex: 1; }
        .filter-count { font-size: 11px; color: #999; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; }
        .capacity-inputs { display: flex; gap: 10px; }
        .capacity-input { flex: 1; }
        .capacity-input label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
        .capacity-input input { width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 6px; }
        
        /* Map */
        .map-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .map-title { font-size: 18px; font-weight: 600; }
        .map-controls { display: flex; gap: 8px; }
        .btn { padding: 8px 14px; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 12px; cursor: pointer; }
        .btn:hover { background: #e8e8e8; }
        .btn.active { background: #667eea; color: white; border-color: #667eea; }
        #map { height: 600px; width: 100%; }
        .map-note { padding: 12px 20px; background: #fff3cd; border-top: 1px solid #ffc107; font-size: 12px; color: #856404; }

        /* Map Legend */
        .map-legend { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px; line-height: 1.8; }
        .map-legend h4 { margin: 0 0 8px 0; font-size: 13px; font-weight: 600; }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .legend-color { width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; }
        .legend-color.bordered { border-color: #FFA500; }
        
        /* Stats */
        .stats-card { padding: 20px; margin-bottom: 20px; }
        .stats-card h3 { font-size: 14px; font-weight: 600; margin-bottom: 16px; color: #555; text-transform: uppercase; }
        .stat-item { margin-bottom: 16px; }
        .stat-item-label { font-size: 12px; color: #666; margin-bottom: 6px; }
        .stat-row { display: flex; align-items: center; gap: 10px; }
        .stat-num { font-size: 20px; font-weight: 700; min-width: 80px; }
        .progress-bar { flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s; }
        .chart-container { height: 200px; }
        
        /* Facilities */
        .facilities-header { display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f0f0f0; }
        .facilities-header h2 { font-size: 18px; }
        .facility-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .facility-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: #667eea; }
        .facility-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .facility-name { font-size: 15px; font-weight: 600; flex: 1; }
        .badges { display: flex; gap: 6px; }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: 600; text-transform: uppercase; }
        .badge-licensed { background: #d4edda; color: #155724; }
        .badge-closed { background: #f8d7da; color: #721c24; }
        .badge-elfa { background: #e7d4f5; color: #5a1c7d; }
        .badge-sfusd { background: #d1c4e9; color: #4a148c; }
        .facility-details { font-size: 13px; color: #666; line-height: 1.6; }
        .facility-capacity { display: inline-block; margin-top: 8px; padding: 4px 10px; background: #f0f0f0; border-radius: 6px; font-size: 12px; font-weight: 600; }
        
        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0; }
        .page-btn { padding: 8px 14px; background: white; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; }
        .page-btn:hover { background: #f5f5f5; }
        .page-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .modal { background: white; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h2 { font-size: 20px; }
        .modal-close { cursor: pointer; font-size: 24px; color: #999; background: none; border: none; }
        .modal-section { margin-bottom: 24px; }
        .modal-section h3 { font-size: 16px; margin-bottom: 12px; color: #667eea; }
        .modal-section p { font-size: 14px; line-height: 1.6; color: #666; }
        .modal-section ul { margin-left: 20px; }
        .modal-section li { font-size: 14px; line-height: 1.8; }
        .modal-section a { color: #667eea; text-decoration: none; }
        
        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; gap: 20px; }
        .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } .sidebar { position: static; } }
        @media (max-width: 768px) { .header-content { flex-direction: column; align-items: flex-start; } #map { height: 400px; } }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // Load data from external JSON
        window.CHILDCARE_DATA = null;
        fetch('./childcare_all_coordinates.json')
            .then(r => r.json())
            .then(d => {
                window.CHILDCARE_DATA = d;
                const withCoords = d.filter(f => f.latitude && f.longitude).length;
                const jittered = d.filter(f => f.tags?.address_source === 'zip_code_approximate').length;
                console.log('‚úì Loaded', d.length, 'facilities,', withCoords, 'have coordinates (' + jittered + ' jittered from ZIP codes)');
                if (window.onDataLoad) window.onDataLoad();
            })
            .catch(e => alert('Error loading data. Run a local server (see instructions) or use standalone version.'));
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        const App = () => {
            const [data, setData] = useState([]);
            const [search, setSearch] = useState('');
            const [open, setOpen] = useState('type');
            const [typeF, setTypeF] = useState([]);
            const [statusF, setStatusF] = useState([]);
            const [elfaF, setElfaF] = useState([]);
            const [minCap, setMinCap] = useState('');
            const [maxCap, setMaxCap] = useState('');
            const [sfusdOnly, setSfusdOnly] = useState(false);
            const [heatmap, setHeatmap] = useState(true);
            const [markers, setMarkers] = useState(true);
            const [modal, setModal] = useState(false);
            const [page, setPage] = useState(1);
            const [mapBoundsFilter, setMapBoundsFilter] = useState(false);
            const [currentBounds, setCurrentBounds] = useState(null);
            const perPage = 25;
            
            const mapRef = useRef(null);
            const mapInst = useRef(null);
            const heatLayer = useRef(null);
            const markerLayer = useRef(null);
            const chartRef = useRef(null);
            const chartInst = useRef(null);
            
            useEffect(() => {
                if (window.CHILDCARE_DATA) {
                    setData(window.CHILDCARE_DATA);
                } else {
                    window.onDataLoad = () => setData(window.CHILDCARE_DATA);
                }
            }, []);
            
            const types = useMemo(() => [...new Set(data.map(f => f.facility_type))].sort(), [data]);
            const statuses = useMemo(() => [...new Set(data.map(f => f.facility_status))].sort(), [data]);
            
            const filtered = useMemo(() => {
                let f = [...data];
                if (search) {
                    const s = search.toLowerCase();
                    f = f.filter(x => x.facility_name?.toLowerCase().includes(s) ||
                                      x.facility_address?.toLowerCase().includes(s) ||
                                      x.sfusd_school_name?.toLowerCase().includes(s));
                }
                if (typeF.length) f = f.filter(x => typeF.includes(x.facility_type));
                if (statusF.length) f = f.filter(x => statusF.includes(x.facility_status));
                if (elfaF.length) f = f.filter(x => elfaF.includes(x.elfa_contracted));
                if (minCap) f = f.filter(x => (x.facility_capacity || 0) >= parseInt(minCap));
                if (maxCap) f = f.filter(x => (x.facility_capacity || 0) <= parseInt(maxCap));
                if (sfusdOnly) f = f.filter(x => x.sfusd_site === 'Yes');

                // Filter by map bounds if enabled
                if (mapBoundsFilter && currentBounds) {
                    f = f.filter(x => {
                        if (!x.latitude || !x.longitude) return false;
                        return currentBounds.contains([x.latitude, x.longitude]);
                    });
                }

                return f;
            }, [data, search, typeF, statusF, elfaF, minCap, maxCap, sfusdOnly, mapBoundsFilter, currentBounds]);
            
            const stats = useMemo(() => {
                const cap = filtered.reduce((s, f) => s + (f.facility_capacity || 0), 0);
                const lic = filtered.filter(f => f.facility_status === 'LICENSED').length;
                const sfu = filtered.filter(f => f.sfusd_site === 'Yes').length;
                return {
                    total: filtered.length,
                    cap: cap,
                    lic: lic,
                    licPct: filtered.length > 0 ? Math.round((lic / filtered.length) * 100) : 0,
                    sfu: sfu
                };
            }, [filtered]);
            
            const totalPages = Math.ceil(filtered.length / perPage);
            const paged = useMemo(() => {
                const start = (page - 1) * perPage;
                return filtered.slice(start, start + perPage);
            }, [filtered, page]);
            
            useEffect(() => { setPage(1); }, [filtered.length]);
            
            useEffect(() => {
                if (!data.length) {
                    console.log('‚è≥ Waiting for data to load before initializing map...');
                    return;
                }
                if (!mapRef.current) {
                    console.log('‚è≥ Map ref not ready yet...');
                    return;
                }
                if (mapInst.current) {
                    console.log('Map already initialized');
                    return;
                }
                console.log('Initializing map...');
                try {
                    // SF boundaries (approximately)
                    const sfBounds = L.latLngBounds(
                        L.latLng(37.70, -122.52),  // Southwest corner
                        L.latLng(37.83, -122.35)   // Northeast corner
                    );

                    const m = L.map(mapRef.current, {
                        maxBounds: sfBounds,
                        maxBoundsViscosity: 0.75,  // Makes bounds "sticky"
                        minZoom: 11,
                        maxZoom: 18
                    }).setView([37.7749, -122.4194], 12);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(m);

                    // Add legend
                    const legend = L.control({position: 'bottomright'});
                    legend.onAdd = function() {
                        const div = L.DomUtil.create('div', 'map-legend');
                        div.innerHTML = `
                            <h4>Status</h4>
                            <div class="legend-item"><div class="legend-color" style="background:#4CAF50;"></div><span>Licensed</span></div>
                            <div class="legend-item"><div class="legend-color" style="background:#f44336;"></div><span>Closed</span></div>
                            <div class="legend-item"><div class="legend-color" style="background:#ff9800;"></div><span>Inactive</span></div>
                            <div class="legend-item"><div class="legend-color" style="background:#2196F3;"></div><span>Other</span></div>
                            <h4 style="margin-top:8px;">Location</h4>
                            <div class="legend-item"><div class="legend-color" style="background:#4CAF50; border-color:white;"></div><span>Geocoded</span></div>
                            <div class="legend-item"><div class="legend-color bordered" style="background:#4CAF50;"></div><span>ZIP-based</span></div>
                        `;
                        return div;
                    };
                    legend.addTo(m);

                    mapInst.current = m;
                    heatLayer.current = L.layerGroup().addTo(m);
                    markerLayer.current = L.layerGroup().addTo(m);

                    // Add map bounds change listener
                    m.on('moveend zoomend', () => {
                        if (mapBoundsFilter) {
                            setCurrentBounds(m.getBounds());
                        }
                    });

                    console.log('‚úì Map initialized successfully with SF bounds and legend');
                } catch (e) {
                    console.error('‚úó Map initialization failed:', e);
                }
            }, [data.length, mapBoundsFilter]);
            
            useEffect(() => {
                if (!mapInst.current) {
                    console.log('‚è≥ Waiting for map to initialize...');
                    return;
                }
                console.log('Updating map layers...');
                heatLayer.current.clearLayers();
                markerLayer.current.clearLayers();

                const valid = filtered.filter(f => f.latitude && f.longitude);
                console.log('Map update:', valid.length, 'facilities with coordinates');
                
                if (heatmap && valid.length) {
                    const heat = valid.map(f => [f.latitude, f.longitude, (f.facility_capacity || 10) / 100]);
                    L.heatLayer(heat, {radius: 25, blur: 15, maxZoom: 17}).addTo(heatLayer.current);
                    console.log('‚úì Heatmap layer added');
                }

                if (markers) {
                    let markerCount = 0;
                    valid.forEach(f => {
                        const color = f.facility_status === 'LICENSED' ? '#4CAF50' :
                                     f.facility_status === 'CLOSED' ? '#f44336' :
                                     f.facility_status === 'INACTIVE' ? '#ff9800' : '#2196F3';
                        const isJittered = f.tags?.address_source === 'zip_code_approximate';
                        const m = L.circleMarker([f.latitude, f.longitude], {
                            radius: Math.sqrt(f.facility_capacity || 10) * 1.5,
                            fillColor: color,
                            color: isJittered ? '#FFA500' : 'white',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: isJittered ? 0.5 : 0.7
                        });
                        const addressText = f.facility_address || `ZIP ${f.facility_zip} (approximate)`;
                        m.bindPopup(`<strong>${f.facility_name}</strong><br>License #: ${f.facility_number}<br>Type: ${f.facility_type}<br>${addressText}<br>Capacity: ${f.facility_capacity}<br>Status: ${f.facility_status}${f.sfusd_site === 'Yes' ? '<br><strong style="color:#673AB7">SFUSD: ' + f.sfusd_school_name + '</strong>' : ''}${isJittered ? '<br><em style="color:#FF8C00">‚ö†Ô∏è Location approximate</em>' : ''}`);
                        m.addTo(markerLayer.current);
                        markerCount++;
                    });
                    console.log(`‚úì Added ${markerCount} markers to map`);
                }
            }, [filtered, heatmap, markers]);
            
            useEffect(() => {
                if (!chartRef.current) return;
                if (chartInst.current) chartInst.current.destroy();
                
                const ranges = ['0-20', '21-50', '51-100', '101-200', '200+'];
                const counts = ranges.map((r, i) => {
                    const [min, max] = r.split('-').map(n => n === '200+' ? Infinity : parseInt(n));
                    return filtered.filter(f => {
                        const c = f.facility_capacity || 0;
                        return max === Infinity ? c > min : c >= min && c <= max;
                    }).length;
                });
                
                chartInst.current = new Chart(chartRef.current, {
                    type: 'bar',
                    data: {
                        labels: ranges,
                        datasets: [{label: 'Facilities', data: counts, backgroundColor: 'rgba(102,126,234,0.8)'}]
                    },
                    options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}, scales: {y: {beginAtZero: true}}}
                });
            }, [filtered]);
            
            const toggle = (arr, set, val) => {
                set(arr.includes(val) ? arr.filter(v => v !== val) : [...arr, val]);
            };

            const clearAllFilters = () => {
                setSearch('');
                setTypeF([]);
                setStatusF([]);
                setElfaF([]);
                setMinCap('');
                setMaxCap('');
                setSfusdOnly(false);
            };

            const activeFilterCount = typeF.length + statusF.length + elfaF.length +
                                     (minCap ? 1 : 0) + (maxCap ? 1 : 0) + (sfusdOnly ? 1 : 0) + (search ? 1 : 0);
            
            if (!data.length) return <div className="loading"><div className="spinner"></div><div>Loading data...</div></div>;
            
            return <div>
                <div className="header">
                    <div className="header-content">
                        <div>
                            <h1>SF Child Care Dashboard</h1>
                            <p>Licensed Centers & Large FCCs - All facilities mapped (some with approximate ZIP-based locations)</p>
                        </div>
                        <div className="header-stats">
                            <div className="stat-pill"><div className="stat-value">{stats.total.toLocaleString()}</div><div className="stat-label">Facilities</div></div>
                            <div className="stat-pill"><div className="stat-value">{stats.cap.toLocaleString()}</div><div className="stat-label">Capacity</div></div>
                            <div className="stat-pill"><div className="stat-value">{stats.licPct}%</div><div className="stat-label">Licensed</div></div>
                            <div className="stat-pill"><div className="stat-value">{stats.sfu}</div><div className="stat-label">SFUSD</div></div>
                            <div className="help-icon" onClick={() => setModal(true)}>?</div>
                        </div>
                    </div>
                </div>
                
                <div className="container">
                    <div className="grid">
                        <div className="card sidebar">
                            <div className="sidebar-header">
                                <h2>Filters</h2>
                                <input className="search-box" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} />
                            </div>

                            {activeFilterCount > 0 && (
                                <div className="active-filters">
                                    <div className="active-filters-header">Active Filters ({activeFilterCount})</div>
                                    <div className="filter-chips">
                                        {search && <div className="filter-chip">Search: "{search}" <span className="filter-chip-close" onClick={() => setSearch('')}>√ó</span></div>}
                                        {typeF.map(t => <div key={t} className="filter-chip">{t} <span className="filter-chip-close" onClick={() => toggle(typeF, setTypeF, t)}>√ó</span></div>)}
                                        {statusF.map(s => <div key={s} className="filter-chip">{s} <span className="filter-chip-close" onClick={() => toggle(statusF, setStatusF, s)}>√ó</span></div>)}
                                        {elfaF.map(e => <div key={e} className="filter-chip">ELFA: {e} <span className="filter-chip-close" onClick={() => toggle(elfaF, setElfaF, e)}>√ó</span></div>)}
                                        {minCap && <div className="filter-chip">Min: {minCap} <span className="filter-chip-close" onClick={() => setMinCap('')}>√ó</span></div>}
                                        {maxCap && <div className="filter-chip">Max: {maxCap} <span className="filter-chip-close" onClick={() => setMaxCap('')}>√ó</span></div>}
                                        {sfusdOnly && <div className="filter-chip">SFUSD Only <span className="filter-chip-close" onClick={() => setSfusdOnly(false)}>√ó</span></div>}
                                        <button className="clear-all-btn" onClick={clearAllFilters}>Clear All</button>
                                    </div>
                                </div>
                            )}
                            
                            {[
                                {id: 'type', title: 'Facility Type', items: types, filter: typeF, setFilter: setTypeF},
                                {id: 'status', title: 'License Status', items: statuses, filter: statusF, setFilter: setStatusF},
                                {id: 'elfa', title: 'ELFA Contracted', items: ['Yes', 'No'], filter: elfaF, setFilter: setElfaF}
                            ].map(({id, title, items, filter, setFilter}) => (
                                <div key={id} className="filter-section">
                                    <div className="filter-header" onClick={() => setOpen(open === id ? '' : id)}>
                                        <span className="filter-title">{title}</span>
                                        <span className={`filter-arrow ${open === id ? 'open' : ''}`}>‚ñº</span>
                                    </div>
                                    <div className={`filter-content ${open === id ? 'open' : ''}`}>
                                        <div className="filter-body">
                                            {items.map(item => (
                                                <div key={item} className="filter-option">
                                                    <input type="checkbox" id={id + item} checked={filter.includes(item)} onChange={() => toggle(filter, setFilter, item)} />
                                                    <label htmlFor={id + item}>{item}</label>
                                                    <span className="filter-count">{data.filter(f => f[id === 'type' ? 'facility_type' : id === 'status' ? 'facility_status' : 'elfa_contracted'] === item).length}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            
                            <div className="filter-section">
                                <div className="filter-header" onClick={() => setOpen(open === 'cap' ? '' : 'cap')}>
                                    <span className="filter-title">Capacity</span>
                                    <span className={`filter-arrow ${open === 'cap' ? 'open' : ''}`}>‚ñº</span>
                                </div>
                                <div className={`filter-content ${open === 'cap' ? 'open' : ''}`}>
                                    <div className="filter-body">
                                        <div className="capacity-inputs">
                                            <div className="capacity-input"><label>Min</label><input type="number" value={minCap} onChange={e => setMinCap(e.target.value)} placeholder="0" /></div>
                                            <div className="capacity-input"><label>Max</label><input type="number" value={maxCap} onChange={e => setMaxCap(e.target.value)} placeholder="580" /></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="filter-section">
                                <div className="filter-header" onClick={() => setOpen(open === 'special' ? '' : 'special')}>
                                    <span className="filter-title">Special</span>
                                    <span className={`filter-arrow ${open === 'special' ? 'open' : ''}`}>‚ñº</span>
                                </div>
                                <div className={`filter-content ${open === 'special' ? 'open' : ''}`}>
                                    <div className="filter-body">
                                        <div className="filter-option">
                                            <input type="checkbox" id="sfusd" checked={sfusdOnly} onChange={e => setSfusdOnly(e.target.checked)} />
                                            <label htmlFor="sfusd">SFUSD Only</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="card">
                            <div className="map-header">
                                <div className="map-title">Geographic Distribution</div>
                                <div className="map-controls">
                                    <button className={`btn ${heatmap ? 'active' : ''}`} onClick={() => setHeatmap(!heatmap)}>üî• Heatmap</button>
                                    <button className={`btn ${markers ? 'active' : ''}`} onClick={() => setMarkers(!markers)}>üìç Markers</button>
                                    <button className={`btn ${mapBoundsFilter ? 'active' : ''}`} onClick={() => {
                                        setMapBoundsFilter(!mapBoundsFilter);
                                        if (!mapBoundsFilter && mapInst.current) {
                                            setCurrentBounds(mapInst.current.getBounds());
                                        }
                                    }}>üó∫Ô∏è Filter by Map</button>
                                    <button className="btn" onClick={() => mapInst.current?.setView([37.7749, -122.4194], 12)}>üéØ Reset</button>
                                </div>
                            </div>
                            <div id="map" ref={mapRef}></div>
                            <div className="map-note">
                                üìç Click markers for details ‚Ä¢ Use scroll wheel to zoom ‚Ä¢ Click & drag to pan ‚Ä¢ Click "üó∫Ô∏è Filter by Map" to show only facilities in current view ‚Ä¢
                                Legend shows status colors (green=licensed) and location accuracy (orange border=ZIP-based approximation)
                            </div>
                        </div>
                        
                        <div>
                            <div className="card stats-card sidebar">
                                <h3>Quick Stats</h3>
                                {[
                                    {label: 'Total Facilities', val: stats.total, w: '100%'},
                                    {label: 'Total Capacity', val: stats.cap.toLocaleString(), w: '85%'},
                                    {label: 'Licensed', val: stats.licPct + '%', w: stats.licPct + '%'},
                                    {label: 'SFUSD Sites', val: stats.sfu, w: '30%'}
                                ].map((s, i) => (
                                    <div key={i} className="stat-item">
                                        <div className="stat-item-label">{s.label}</div>
                                        <div className="stat-row">
                                            <div className="stat-num">{s.val}</div>
                                            <div className="progress-bar"><div className="progress-fill" style={{width: s.w}}></div></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="card stats-card">
                                <h3>Capacity Distribution</h3>
                                <div className="chart-container"><canvas ref={chartRef}></canvas></div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="card" style={{padding: '20px'}}>
                        <div className="facilities-header">
                            <h2>Facilities</h2>
                            <div>Showing {(page-1)*perPage+1}-{Math.min(page*perPage, filtered.length)} of {filtered.length}</div>
                        </div>
                        
                        {paged.map((f, i) => (
                            <div key={i} className="facility-card">
                                <div className="facility-header">
                                    <div className="facility-name">{f.facility_name}</div>
                                    <div className="badges">
                                        <span className={`badge ${f.facility_status === 'LICENSED' ? 'badge-licensed' : 'badge-closed'}`}>{f.facility_status}</span>
                                        {f.elfa_contracted === 'Yes' && <span className="badge badge-elfa">ELFA</span>}
                                        {f.sfusd_site === 'Yes' && <span className="badge badge-sfusd">SFUSD</span>}
                                        {f.tags?.address_source === 'zip_code_approximate' && <span className="badge" style={{background: '#fff3cd', color: '#856404'}}>üìç ZIP</span>}
                                    </div>
                                </div>
                                <div className="facility-details">
                                    <div><strong>License #:</strong> {f.facility_number}</div>
                                    <div><strong>Type:</strong> {f.facility_type}</div>
                                    <div>{f.facility_address || `ZIP ${f.facility_zip} (address unavailable)`}, {f.facility_city} {f.facility_zip}</div>
                                    {f.sfusd_site === 'Yes' && f.sfusd_school_name && <div style={{color: '#673AB7', marginTop: '4px'}}>üè´ {f.sfusd_school_name}</div>}
                                </div>
                                <div className="facility-capacity">Capacity: {f.facility_capacity || 'N/A'}</div>
                            </div>
                        ))}
                        
                        {totalPages > 1 && (
                            <div className="pagination">
                                <button className="page-btn" onClick={() => setPage(p => Math.max(1, p-1))} disabled={page === 1}>‚Üê Prev</button>
                                {[...Array(Math.min(5, totalPages))].map((_, i) => {
                                    let p = totalPages <= 5 ? i + 1 : page <= 3 ? i + 1 : page >= totalPages - 2 ? totalPages - 4 + i : page - 2 + i;
                                    return <button key={i} className={`page-btn ${page === p ? 'active' : ''}`} onClick={() => setPage(p)}>{p}</button>;
                                })}
                                <button className="page-btn" onClick={() => setPage(p => Math.min(totalPages, p+1))} disabled={page === totalPages}>Next ‚Üí</button>
                            </div>
                        )}
                    </div>
                </div>
                
                {modal && (
                    <div className="modal-overlay" onClick={() => setModal(false)}>
                        <div className="modal" onClick={e => e.stopPropagation()}>
                            <div className="modal-header">
                                <h2>About</h2>
                                <button className="modal-close" onClick={() => setModal(false)}>√ó</button>
                            </div>
                            <div className="modal-section">
                                <h3>‚ö†Ô∏è Data Limitation</h3>
                                <p>This dashboard includes licensed child care <strong>centers and large Family Child Care (FCC)</strong> facilities from CCLD data. <strong>Small FCCs are not included</strong> as they must be deduced from combining SFDEC and CCLD large FCC data using license numbers.</p>
                                <p><strong>Coverage:</strong><br/>‚úì Day Care Centers<br/>‚úì Large FCCs<br/>‚úó Small FCCs (requires cross-reference)</p>
                            </div>
                            <div className="modal-section">
                                <h3>üìç Location Data</h3>
                                <p>Most facilities have been geocoded to precise addresses. Facilities without street addresses (typically small family child care homes) are displayed using <strong>jittered ZIP code centroids</strong> - approximate locations with small random offsets to prevent stacking.</p>
                                <p><strong>Map Legend:</strong><br/>üîµ White-bordered markers: Geocoded addresses<br/>üü† Orange-bordered markers: ZIP-based (jittered)</p>
                            </div>
                            <div className="modal-section">
                                <h3>üìä Data Sources</h3>
                                <ul>
                                    <li><a href="https://sfdec.org/early-learning-for-all/early-learning-programs/" target="_blank">ELFA - SF Dept Early Childhood</a></li>
                                    <li><a href="https://www.ccld.dss.ca.gov/carefacilitysearch/DownloadData" target="_blank">CCLD - CA Licensing</a></li>
                                    <li><a href="https://www.sfusd.edu/schools/directory/table?field_school_type_target_id%5B317%5D=317" target="_blank">SFUSD Directory</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                )}
            </div>;
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>